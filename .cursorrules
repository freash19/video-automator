# TRAE Rules & Project Constitution
# Role: Senior QA Automation Architect

## 1. Tech Stack & Environment
- **Core**: Python 3.14+, FastAPI, Playwright (Async).
- **Frontend**: React + Vite + TypeScript.
- **Ports**: API @ 8000, UI @ 5173.
- **Context**: Automation of external HeyGen interface (no backend control).

## 2. Selector Strategy (Strict)
- **Priority #1**: `data-testid` (e.g., `page.locator('[data-testid="submit-btn"]')`).
- **Priority #2**: `get_by_role` (e.g., `page.get_by_role("button", name="Save")`).
- **Forbidden**: Dynamic/Generated CSS classes (e.g., `.css-1x2y3z`).
- **Internal UI**: If `data-testid` is missing, ADD IT.
- **External UI (HeyGen)**: Use stable attributes (aria-labels, specific classes, text) if `data-testid` is unavailable.

## 3. Granular Reporting & Observability
- **Log File**: `automation.log` in project root.
- **Log Format**: `[TIMESTAMP] [LEVEL] [StepName] Message`
- **Step System**:
  - Every atomic action (click, fill, upload) must return a status: `success`, `failed`, or `skipped`.
  - **Metrics**: Track counts of populated scenes, inserted b-rolls, and skipped steps.
- **Non-blocking Failures**:
  - Critical errors (e.g., login failed) -> **STOP**.
  - Non-critical errors (e.g., b-roll insertion failed) -> **LOG, SCREENSHOT, SKIP, CONTINUE**.
- **Screenshots**:
  - **Directory**: `/debug/screenshots/`
  - **Trigger**: Automatic capture on ANY error (critical or non-critical).

## 4. Coding Standards
- **Python**:
  - Mandatory `async/await`.
  - Mandatory Type Hints for all function signatures.
  - Logic encapsulation: All automation logic resides in `HeyGenAutomation` class.
- **Pattern**: Use a **"Step Wrapper"** decorator or context manager to:
  1. Log start/end of step.
  2. Catch exceptions.
  3. Take screenshots on failure.
  4. Update metrics.
- **Frontend**: Strict TypeScript types.

## 5. Data Handling & Resilience
- **Input**: Validate CSV structure in `uploads/` BEFORE starting automation.
- **State**: Save intermediate progress to JSON (allow resuming interrupted tasks).

## 6. Agent Workflow (Harness)
- **Architect**:
  - MUST verify `docs/PLAN.md` matches user intent before any code changes.
- **Developer**:
  - Implements code using the "Step Wrapper" pattern.
  - Ensures state tracking is hooked up to the UI.
- **Reviewer**:
  - Enforces "No Silent Errors" rule.
  - Verifies that every `try-except` block includes logging and screenshotting.
