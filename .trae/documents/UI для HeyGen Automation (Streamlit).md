## Итоги предпочтений

* Streamlit, JSON‑workflow, только Chrome (CDP), опция headless, русский UI.

* Telegram: добавить `telegram_bot_token`, `telegram_chat_id` в `config.json`.

## Новое: параллельное выполнение

* Параллелизм на уровне `asyncio`:

  * Параллельные задачи: одна задача = один эпизод/часть.

  * Ограничение `max_concurrency` через `asyncio.Semaphore`.

  * Режимы:

    * "Много вкладок": один CDP/браузер, несколько `page` в одном `context`.

    * "Много браузеров": несколько CDP (разные профили/порты), задачи распределяются по ним.

* UI:

  * Ползунок "Параллельно задач".

  * Выбор режима (вкладки/браузеры).

  * Назначение эпизодов к профилям (если несколько CDP).

  * Отдельные прогресс‑индикаторы и логи на задачу + общий прогресс.

* Защита:

  * Политика таймаутов/ретраев, лимит одновременных операций B‑roll.

  * Предупреждение о риске блокировок при высокой параллельности.

## Работа с заставками: рекомендация

* Рекомендуем добавлять заставку на пост‑обработке:

  * Плюсы: единый генерационный шаблон, меньше ручных правок, стабильные шаги UI.

  * Можно гибко управлять заставкой (выбор из списка/загрузка новой) при склейке.

* Альтернатива (в шаблоне, пропуск 1‑й сцены) поддерживается, но требует специальных шагов и повышает риск рассинхронизации.

## Пост‑обработка видео (загрузка/склейка)

* Скачивание готовых частей эпизода со страницы проектов HeyGen (UI‑шаги с устойчивыми локаторами/таймаутами).

* Склейка через ffmpeg:

  * Вставка заставки (опционально): выбор файла из списка или загрузка.

  * Настройки выходного файла: контейнер (mp4), кодек (h264), битрейт/пресет под YouTube.

* Планировщик:

  * Триггер по времени/периодичности или ручной запуск отдельного workflow.

* Путь хранения:

  * По умолчанию — папка проекта, либо выбранная пользователем.

## Экраны Streamlit (обновление)

* "Браузер и параллельность": профили, CDP, headless, режим параллельности, `max_concurrency`.

* "CSV и эпизоды": предпросмотр, статистика (эпизоды/части/сцены, шаблоны из CSV), оценка времени.

* "Конфигурация": все поля `config.json`, добавляем Telegram.

* "Конструктор Workflow": шаги, помощник локаторов (тестер, генератор), сохранение/загрузка JSON.

* "Запуск": выбор workflow, управление, прогресс по задачам, логи и уведомления.

* "Пост‑обработка": скачивание/склейка (с заставкой или без), расписание.

## Библиотека шагов (расширение)

* Генерация (как раньше): `navigate_to_template`, `fill_scene`, `handle_broll`, `delete_empty_scenes`, `save`, `reload_and_validate`, `generate`, `final_submit`, `confirm`, универсальные `click/fill/press/wait_for`.

* Новые шаги для проектов:

  * `open_projects()`, `wait_ready(episode_id/part/title)` — ожидание статуса "Ready".

  * `download_video(episode_id/part/title, target_path)` — скачивание.

  * `ffmpeg_concat(inputs, intro?, output_opts, output_path)` — склейка с опциональной заставкой.

  * `schedule(trigger)` — отложенный запуск набора шагов.

## Уведомления

* Встроенные (Streamlit) + Telegram‑события: вмешательство, ошибки, завершение, новые готовые видео.

* Мутация параметров уведомлений из UI.

## Исполнитель runner

* Управляет пулом задач, маршрутизирует к CDP‑профилям, собирает логи/прогресс.

* Заменяет `input()` диалоги на UI‑модальные окна и Telegram.

* Репорт опирается на `self.report` — `heygen_automation.py:1218–1231`.

## Технологии

* `streamlit`, `apscheduler`, `python-telegram-bot` (или `aiogram`), внешняя утилита `ffmpeg`.

## Верификация

* Dry‑run без CDP — валидатор CSV, проверка workflow, тест селекторов.

* Пробный параллельный запуск на 2 частях (разные вкладки), наблюдение прогресса/логов.

## Оставшиеся уточнения

* Telegram: ок, добавим поля в `config.json`.

* Формат имён файлов при скачивании/склейке (шаблон, напр. `{episode_id}_part_{idx}.mp4`).

* Максимальная параллельность (по умолчанию 2–3, чтобы не перегружать сайт/профиль).

* Предпочтительный каталог для сохранения видео/склеек.

