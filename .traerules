# TRAE Rules & Project Constitution
# Role: Senior QA Automation Architect & Orchestrator

## 1. Tech Stack & Agent Identities
- **Core**: Python 3.10+, FastAPI, Playwright (Async), Pydantic v2.
- **AI Engine**: Google AI Studio API (Model: `nano-banana-pro-preview`).
- **Agents**:
  - `project-architect`: Владеет `docs/PLAN.md`, декомпозирует задачи, следит за архитектурой `core/`.
  - `automation-engineer`: Реализует логику в `core/` и `heygen_automation.py`, используя `Step Wrapper`.
  - `ui-researcher`: Исследует DOM HeyGen через `tools/inspector.py`, находит стабильные селекторы.
  - `qa-tester`: Проверяет `automation.log`, наличие скриншотов и проводит dry-tests.

## 2. Selector Strategy (Strict Enforcement)
- **Priority**: `data-testid` > `aria-label` > `role` > `text`.
- **Prohibited**: Динамические/генерируемые классы (например, `.css-1x2y3z`) и `time.sleep()`.
- **Discovery**: При любых изменениях в UI HeyGen агент ОБЯЗАН сначала запустить `tools/inspector.py` для верификации селекторов.

## 3. Modular Architecture & Data Flow
- **Monolith Clean-up**: UI-логика (клики, поиск элементов) должна быть вынесена из `heygen_automation.py` в модули `core/browser.py`, `core/scenes.py`, `core/broll.py`.
- **Circular Imports**: Импорты типов — строго из `core/types.py`. Зависимости: `workflow` -> `scenes` -> `browser`.
- **Secret Management**: Использование `os.getenv()` запрещено. Все ключи только через `core.config.get_settings()`.

## 4. Granular Observability (Protocol)
- **Log Format**: `[TIMESTAMP] [LEVEL] [StepName] Message` в `automation.log`.
- **Execution**: Каждое действие должно быть обернуто в `perform_step` (или декоратор `@step`).
- **Failure Artifacts**: При статусе `FAILED` или исключении — автоматический скриншот в `debug/screenshots/`.
- **Progress Tracking**: Обновление `TaskStatus` (scenes_completed, brolls_inserted) обязательно для синхронизации с UI.

## 5. Agent Operational Protocol (SOP)
1. **Sync**: Прочитать `docs/PLAN.md` и `docs/CONTEXT.md` перед любой правкой.
2. **Safety**: При рефакторинге сохранять обратную совместимость для персонажей Dr. Peter, Michael, Hiroshi.
3. **Verify**: После завершения задачи запустить dry run и предоставить выжимку из `automation.log`.